package soulwire.ui{	import gs.TweenLite;	import gs.easing.Expo;	import flash.display.Sprite;	import flash.events.MouseEvent;	import flash.geom.Point;	import flash.utils.Dictionary;		/**	 * @author justinwindle	 */	public class ShuffleGrid extends Sprite 	{		public var tweenTime : Number = 0.2;		public var itemAlphaOff : Number = 0.8;		public function get numCells() : int		{			return _rows * _cols;		}		private var _rows : int;		private var _cols : int;		private var _padd : int;		private var _rowSize : int;		private var _colSize : int;		private var _index : Array;		private var _items : Array;		private var _numItems : int;		private var _dictionary : Dictionary;		private var _currentItem : ShuffleGridItem;		public function ShuffleGrid(rows : int, cols : int, rowSize : int, colSize : int, padding : Number = 0)		{			_rows = rows;			_cols = cols;			_padd = padding;			_rowSize = rowSize;			_colSize = colSize;			_numItems = 0;						initIndex();		}		public function addItem(item : ShuffleGridItem) : ShuffleGridItem		{			var col : int = _numItems % _cols;			var row : int = Math.floor(_numItems / _cols);			var itemVO : ShuffleGridItemVO = new ShuffleGridItemVO();			var position : Point = getPosition(row, col);						itemVO.row = row;			itemVO.col = col;			itemVO.item = item;						item.x = position.x;			item.y = position.y;						item.mouseEnabled = true;			item.buttonMode = true;						item.addEventListener(MouseEvent.MOUSE_DOWN, onItemPress);			item.addEventListener(MouseEvent.MOUSE_UP, onItemRelease);						addChild(item);						_items.push(item);			_index[row][col] = itemVO;			_dictionary[item] = itemVO;			_numItems++;						return item;		}		public function getItemAt(index : int) : ShuffleGridItem		{			return _items[index];		}		public function getItemAtPosition(row : int, col : int) : ShuffleGridItem		{			return _index[row][col];		}		private function initIndex() : void		{			_dictionary = new Dictionary();			_index = new Array(_rows);			_items = [];						for (var i : int = 0;i < _rows; i++)			{				_index[i] = new Array(_cols);			}		}		private function shuffleItems() : void		{			var itemVO : ShuffleGridItemVO = _dictionary[_currentItem];			var cell : Point = getCell(_currentItem.x, _currentItem.y);						var col : int = cell.x;			var row : int = cell.y;						if(col == itemVO.col && row == itemVO.row)			{				return;			}						var hMove : int = col - itemVO.col;			var vMove : int = row - itemVO.row;						var i : int;			var item : ShuffleGridItemVO;			var move : Array = [];			if(hMove < 0)			{				for (i = itemVO.col - 1;i >= itemVO.col + hMove; i--)				{					if(_index[itemVO.row][i])					{						item = _index[itemVO.row][i];						item.col++;												_index[item.row][item.col] = item;						move.push(item);					}				}			}			else			{				for (i = itemVO.col + 1;i <= itemVO.col + hMove; i++)				{					if(_index[itemVO.row][i])					{						item = _index[itemVO.row][i];						item.col--;												_index[item.row][item.col] = item;						move.push(item);					}				}			}			if(vMove < 0)			{				for (i = itemVO.row - 1;i >= itemVO.row + vMove; i--)				{					if(_index[i][itemVO.col + hMove])					{						item = _index[i][itemVO.col + hMove];						item.row++;												_index[item.row][item.col] = item;						move.push(item);					}				}			}			else			{				for (i = itemVO.row + 1;i <= itemVO.row + vMove; i++)				{					if(_index[i][itemVO.col + hMove])					{						item = _index[i][itemVO.col + hMove];						item.row--;												_index[item.row][item.col] = item;						move.push(item);					}				}			}						for (i = 0;i < move.length; i++)			{				snapToGrid(move[i]);			}						itemVO.row = row;			itemVO.col = col;						_index[row][col] = itemVO;		}		private function snapToGrid(item : ShuffleGridItemVO) : void		{			var pos : Point = getPosition(item.row, item.col);			TweenLite.to(item.item, tweenTime, {x:pos.x, y:pos.y, ease:Expo.easeInOut});		}		private function getPosition(row : int, col : int) : Point		{			return new Point(col * (_colSize + _padd), row * (_rowSize + _padd));		}		private function getCell(x : Number, y : Number) : Point		{			var cell : Point = new Point();						cell.x = Math.max(0, Math.min(_cols - 1, Math.round(x / (_colSize + _padd))));			cell.y = Math.max(0, Math.min(_rows - 1, Math.round(y / (_rowSize + _padd))));						return cell;		}		private function onItemPress(event : MouseEvent) : void		{			_currentItem = event.currentTarget as ShuffleGridItem;			_currentItem.addEventListener(MouseEvent.MOUSE_OUT, onItemRelease);			_currentItem.alpha = itemAlphaOff;			_currentItem.startDrag();						stage.addEventListener(MouseEvent.MOUSE_MOVE, onItemMove);			addChild(_currentItem);		}		private function onItemMove(event : MouseEvent) : void		{			shuffleItems();		}		private function onItemRelease(event : MouseEvent) : void		{			_currentItem.removeEventListener(MouseEvent.MOUSE_OUT, onItemRelease);			_currentItem.alpha = 1.0;			_currentItem.stopDrag();						stage.removeEventListener(MouseEvent.MOUSE_MOVE, onItemMove);			snapToGrid(_dictionary[_currentItem]);		}	}}import soulwire.ui.ShuffleGridItem;internal class ShuffleGridItemVO{	public var row : int;	public var col : int;	public var item : ShuffleGridItem;}